import json 
import os 
import sys, getopt
import datetime
import importlib, copy
from importlib import util

config = {"input":"raw","output":"glm","type":[],"format":[]}

def help():
    return """raw2glm.py -i <inputfile> -o <outputfile> [options...]
    -c|--config              output converter configuration data
    -h|--help                output this help
    -i|--ifile <filename>    [REQUIRED] PY input file
    -o|--ofile <filename>    [OPTIONAL] GLM output file name
"""

def main():
    filename_raw = None
    filename_glm = None
    try : 
        opts, args = getopt.getopt(sys.argv[1:],
            "chi:o:",
            ["config","help","ifile=","ofile="],
            )
    except getopt.GetoptError:
        sys.exit(2)
    if not opts : 
        print('ERROR [raw2glm.py]: missing command arguments')
        sys.exit(2)
    for opt, arg in opts:
        if opt in ("-c","--config"):
            print(config)
            sys.exit()
        elif opt in ("-h","--help"):
            print(help())
            sys.exit()
        elif opt in ("-i", "--ifile"):
            filename_raw = arg
        elif opt in ("-o", "--ofile"):
            filename_glm = arg
        else : 
            print(f"ERROR [raw2glm.py]: {opt}={arg} is not a valid option")
            sys.exit(1)

    if not filename_raw:
        print(f"ERROR [raw2glm.py]: input filename not specified")
        sys.exit(1)

    try:
        convert(
            ifile = filename_raw,
            ofile = filename_glm,
            options = dict(),
            )
    except Exception as err:
        print(f"ERROR [raw2glm.py]: {err}")
        import traceback
        traceback.print_exception(err,file=sys.stderr)
        sys.exit(9)

def convert(ifile,ofile,options={}):
    """Default converter PSS/E RAW file (version 34-ish)"""

    with open(ifile,"r") as raw:
        data = dict(
            version = 2, 
            baseMVA = 100.0,
            bus = [],
            branch = [],
            gen = [],
            )

    NL='\n'
    with open(ofile,"w") as glm:
        glm.write(f"""// generated by {' '.join(sys.argv)}
module pypower
{{
    version {data['version']};
    baseMVA {data['baseMVA']};
}}
""")

        for name,spec in dict(
            # pypower properties must be in the save order as the case array columns
            bus = "bus_i type Pd Qd Gs Bs area Vm Va baseKV zone Vmax Vmin",
            gen = "bus Pg Qg Qmax Qmin Vg mBase status Pmax Pmin Pc1 Pc2 Qc1min"\
                + " Qc1max Qc2min Qc2max ramp_agc ramp_10 ramp_30 ramp_q apf",
            branch = "fbus tbus r x b rateA rateB rateC ratio angle status angmin angmax",
        ).items():
            glm.write(f"{NL}//{NL}// {name}{NL}//{NL}")
            for n,line in enumerate(data[name]):
                oname = f"{NL}    name pp_{name}_{n+1};" if autoname else ""
                glm.write(f"""object pypower.{name} 
{{{oname}
{NL.join([f"    {x} {line[n]};" for n,x in enumerate(spec.split())])}
}}
""")
        if 'gencost' in data:
            glm.write("\n//\n// gencost\n//\n")
            for n,line in enumerate(data['gencost']):
                model = line[0]
                startup = line[1]
                shutdown = line[2]
                count = line[3]
                costs = line[4:]
                assert(len(costs)==count)
                oname = f"{NL}    name pp_gencost_{n};" if autoname else ""
                glm.write(f"""object pypower.gencost
{{{oname}
    model {int(model)};
    startup {startup};
    shutdown {shutdown};
    costs "{','.join([str(x) for x in costs])}";
}}
""")

if __name__ == '__main__':
    main()

